theory FAQ
  imports Main
begin

(* ========================================
   TYPE DEFINITIONS
   ======================================== *)

(* Category types for organizing questions *)
datatype category = 
  Academic | 
  Administrative | 
  Financial | 
  Registration | 
  Graduation | 
  Appeals | 
  Documents |
  Schedule |
  Policies

(* FAQ Entry structure *)
record faq_entry =
  question :: string
  answer :: string
  keywords :: "string list"
  cat :: category

(* ========================================
   KNOWLEDGE BASE DATA
   ======================================== *)

definition academic_faqs :: "faq_entry list" where
"academic_faqs = [
  \<lparr> question = ''What is the minimum GPA required to graduate?'',
    answer = ''The minimum cumulative GPA required for graduation is 2.0 on a 4.0 scale. Some programs may require higher GPAs.'',
    keywords = [''GPA'', ''graduate'', ''minimum'', ''requirement''],
    cat = Academic \<rparr>,
    
  \<lparr> question = ''How do I change my major?'',
    answer = ''To change your major, you must: 1) Meet with your academic advisor, 2) Fill out the Change of Major form available at the Dean's office, 3) Get approval from both your current and new department heads, 4) Submit the form to the Registrar's office.'',
    keywords = [''change'', ''major'', ''switch'', ''program''],
    cat = Academic \<rparr>,
    
  \<lparr> question = ''Can I take courses from other departments?'',
    answer = ''Yes, you can take elective courses from other departments. However, you must ensure they don't conflict with your core requirements and that you have met any prerequisites.'',
    keywords = [''elective'', ''other department'', ''courses'', ''cross-department''],
    cat = Academic \<rparr>,
    
  \<lparr> question = ''What is academic probation?'',
    answer = ''Academic probation occurs when your GPA falls below 2.0. You will have one semester to raise your GPA above 2.0, or face academic suspension.'',
    keywords = [''probation'', ''academic'', ''GPA'', ''suspension''],
    cat = Academic \<rparr>,
    
  \<lparr> question = ''How do I apply for academic leave?'',
    answer = ''Submit an Academic Leave of Absence form to the Dean's office at least two weeks before the semester starts. You must provide valid reasons and may need supporting documentation.'',
    keywords = [''leave'', ''absence'', ''defer'', ''postpone''],
    cat = Academic \<rparr>
]"

definition registration_faqs :: "faq_entry list" where
"registration_faqs = [
  \<lparr> question = ''When is the registration period?'',
    answer = ''Registration typically opens 4 weeks before the semester begins. Priority registration is given to seniors, then juniors, sophomores, and finally freshmen. Check the academic calendar for exact dates.'',
    keywords = [''registration'', ''enroll'', ''when'', ''period'', ''dates''],
    cat = Registration \<rparr>,
    
  \<lparr> question = ''How do I add or drop a course?'',
    answer = ''You can add courses during the first week of the semester through the online portal. Courses can be dropped without penalty during the first two weeks. After that, you need instructor and dean approval.'',
    keywords = [''add'', ''drop'', ''course'', ''withdraw''],
    cat = Registration \<rparr>,
    
  \<lparr> question = ''What is the maximum course load per semester?'',
    answer = ''Full-time students can take 12-18 credit hours per semester. If you wish to take more than 18 credits, you need special permission from the Dean's office and must have a GPA of at least 3.0.'',
    keywords = [''credit'', ''load'', ''maximum'', ''overload''],
    cat = Registration \<rparr>,
    
  \<lparr> question = ''Can I register for a closed class?'',
    answer = ''If a class is full, you can join the waitlist. Contact the instructor to request permission to enroll, or check daily for openings as students may drop.'',
    keywords = [''closed'', ''full'', ''waitlist'', ''class''],
    cat = Registration \<rparr>,
    
  \<lparr> question = ''What are prerequisites and how do I waive them?'',
    answer = ''Prerequisites are courses you must complete before enrolling in advanced courses. To waive a prerequisite, you must demonstrate equivalent knowledge and get written approval from the course instructor and department head.'',
    keywords = [''prerequisite'', ''waive'', ''requirement'', ''prior''],
    cat = Registration \<rparr>
]"

definition financial_faqs :: "faq_entry list" where
"financial_faqs = [
  \<lparr> question = ''When are tuition fees due?'',
    answer = ''Tuition fees are due two weeks before the start of each semester. Late payment incurs a penalty fee and may result in course deregistration.'',
    keywords = [''tuition'', ''fees'', ''payment'', ''due'', ''deadline''],
    cat = Financial \<rparr>,
    
  \<lparr> question = ''How do I apply for financial aid?'',
    answer = ''Submit the Financial Aid Application form available on the university website or at the Financial Aid office. The deadline is usually three months before the semester starts. You must provide income documentation and maintain a minimum GPA of 2.5.'',
    keywords = [''financial aid'', ''scholarship'', ''bursary'', ''apply''],
    cat = Financial \<rparr>,
    
  \<lparr> question = ''Can I get a tuition refund if I withdraw?'',
    answer = ''Refunds are provided on a sliding scale: 100% refund if you withdraw before classes start, 75% in the first week, 50% in the second week, and no refund after the second week.'',
    keywords = [''refund'', ''withdraw'', ''tuition'', ''money back''],
    cat = Financial \<rparr>,
    
  \<lparr> question = ''Are payment plans available?'',
    answer = ''Yes, you can request an installment payment plan through the Bursar's office. You must apply before the semester starts and may need to pay a processing fee.'',
    keywords = [''payment plan'', ''installment'', ''pay'', ''monthly''],
    cat = Financial \<rparr>,
    
  \<lparr> question = ''How do I appeal a financial aid decision?'',
    answer = ''Submit a written appeal to the Financial Aid Appeals Committee within 10 days of the decision. Include any new documentation supporting your case.'',
    keywords = [''appeal'', ''financial'', ''decision'', ''challenge''],
    cat = Financial \<rparr>
]"

definition graduation_faqs :: "faq_entry list" where
"graduation_faqs = [
  \<lparr> question = ''How do I apply for graduation?'',
    answer = ''Submit a Graduation Application form to the Registrar's office at least one semester before your expected graduation date. There is an application fee, and you must have completed all degree requirements.'',
    keywords = [''graduation'', ''apply'', ''graduate'', ''degree''],
    cat = Graduation \<rparr>,
    
  \<lparr> question = ''What is the deadline for graduation application?'',
    answer = ''The graduation application deadline is October 1st for December graduation, February 1st for May graduation, and June 1st for August graduation.'',
    keywords = [''deadline'', ''graduation'', ''apply'', ''when''],
    cat = Graduation \<rparr>,
    
  \<lparr> question = ''Can I graduate early?'',
    answer = ''Yes, if you have completed all degree requirements including the minimum 120 credit hours and all major-specific courses. Consult with your academic advisor to ensure all requirements are met.'',
    keywords = [''early'', ''graduate'', ''finish'', ''complete''],
    cat = Graduation \<rparr>,
    
  \<lparr> question = ''How do I obtain my diploma?'',
    answer = ''Diplomas are mailed to your address on record 6-8 weeks after graduation. You can also pick it up in person from the Registrar's office after that period.'',
    keywords = [''diploma'', ''certificate'', ''degree'', ''obtain''],
    cat = Graduation \<rparr>,
    
  \<lparr> question = ''What are graduation honors requirements?'',
    answer = ''Cum Laude requires a GPA of 3.5-3.69, Magna Cum Laude requires 3.7-3.89, and Summa Cum Laude requires 3.9-4.0. You must also complete at least 60 credit hours at this institution.'',
    keywords = [''honors'', ''cum laude'', ''distinction'', ''GPA''],
    cat = Graduation \<rparr>
]"

definition administrative_faqs :: "faq_entry list" where
"administrative_faqs = [
  \<lparr> question = ''How do I get a transcript?'',
    answer = ''Official transcripts can be requested through the Registrar's office or online portal. There is a processing fee per copy, and it takes 3-5 business days for processing.'',
    keywords = [''transcript'', ''records'', ''official'', ''grades''],
    cat = Documents \<rparr>,
    
  \<lparr> question = ''How do I update my personal information?'',
    answer = ''Log into the student portal to update your address, phone number, and email. For name changes, you must submit legal documentation to the Registrar's office.'',
    keywords = [''update'', ''information'', ''address'', ''name'', ''change''],
    cat = Administrative \<rparr>,
    
  \<lparr> question = ''What is a Letter of Good Standing?'',
    answer = ''A Letter of Good Standing confirms you are enrolled, in good academic standing, and have no disciplinary issues. Request it from the Dean's office with 3 days notice.'',
    keywords = [''letter'', ''good standing'', ''enrollment'', ''verification''],
    cat = Documents \<rparr>,
    
  \<lparr> question = ''How do I get an enrollment verification letter?'',
    answer = ''Enrollment verification letters can be requested through the Registrar's office or generated instantly through the online portal if you are currently enrolled.'',
    keywords = [''enrollment'', ''verification'', ''letter'', ''proof''],
    cat = Documents \<rparr>,
    
  \<lparr> question = ''What are the Dean's office hours?'',
    answer = ''The Dean's office is open Monday through Friday, 8:00 AM to 5:00 PM. We are closed on weekends and university holidays. Appointments are recommended for complex matters.'',
    keywords = [''hours'', ''open'', ''office'', ''time'', ''appointment''],
    cat = Administrative \<rparr>
]"

definition appeals_faqs :: "faq_entry list" where
"appeals_faqs = [
  \<lparr> question = ''How do I appeal a grade?'',
    answer = ''First, discuss the grade with your instructor within one week of receiving it. If unresolved, submit a Grade Appeal form to the Dean's office within 30 days, including documentation supporting your case.'',
    keywords = [''appeal'', ''grade'', ''challenge'', ''dispute''],
    cat = Appeals \<rparr>,
    
  \<lparr> question = ''Can I appeal an academic dismissal?'',
    answer = ''Yes, you can appeal academic dismissal within 10 days of notification. Submit a written appeal explaining extenuating circumstances with supporting documentation to the Academic Standards Committee.'',
    keywords = [''appeal'', ''dismissal'', ''suspension'', ''expelled''],
    cat = Appeals \<rparr>,
    
  \<lparr> question = ''How long does the appeal process take?'',
    answer = ''Grade appeals typically take 2-4 weeks. Academic dismissal appeals are reviewed within 15 business days. You will be notified of the decision in writing.'',
    keywords = [''appeal'', ''how long'', ''time'', ''process''],
    cat = Appeals \<rparr>,
    
  \<lparr> question = ''Can I appeal a denied transfer credit?'',
    answer = ''Yes, submit a Transfer Credit Appeal form with your course syllabus, transcripts, and any other relevant materials to the Dean's office for review.'',
    keywords = [''appeal'', ''transfer'', ''credit'', ''course''],
    cat = Appeals \<rparr>
]"

definition schedule_faqs :: "faq_entry list" where
"schedule_faqs = [
  \<lparr> question = ''Where can I find the academic calendar?'',
    answer = ''The academic calendar is available on the university website under Academics > Academic Calendar. It includes all important dates for registration, add/drop, holidays, and exams.'',
    keywords = [''calendar'', ''dates'', ''schedule'', ''semester''],
    cat = Schedule \<rparr>,
    
  \<lparr> question = ''When are final exams?'',
    answer = ''Final exams are held during the last week of each semester. The detailed exam schedule is published four weeks before the exam period on the Registrar's website.'',
    keywords = [''final'', ''exam'', ''test'', ''when'', ''schedule''],
    cat = Schedule \<rparr>,
    
  \<lparr> question = ''Are classes held on holidays?'',
    answer = ''No classes are held on official university holidays. Check the academic calendar for the complete list of holidays including national holidays and university-specific breaks.'',
    keywords = [''holiday'', ''break'', ''classes'', ''closed''],
    cat = Schedule \<rparr>,
    
  \<lparr> question = ''What is reading week?'',
    answer = ''Reading week is a one-week break before final exams with no classes scheduled. It gives students time to prepare for exams and complete final projects.'',
    keywords = [''reading week'', ''study'', ''break'', ''exams''],
    cat = Schedule \<rparr>
]"

definition policy_faqs :: "faq_entry list" where
"policy_faqs = [
  \<lparr> question = ''What is the attendance policy?'',
    answer = ''Students are expected to attend all classes. Individual instructors set specific attendance policies. Missing more than 25% of classes may result in automatic failure.'',
    keywords = [''attendance'', ''policy'', ''absence'', ''classes''],
    cat = Policies \<rparr>,
    
  \<lparr> question = ''What is the academic honesty policy?'',
    answer = ''Academic dishonesty including plagiarism, cheating, and unauthorized collaboration is strictly prohibited. Violations result in penalties ranging from failing grades to expulsion.'',
    keywords = [''honesty'', ''plagiarism'', ''cheating'', ''policy''],
    cat = Policies \<rparr>,
    
  \<lparr> question = ''Can I audit a course?'',
    answer = ''Yes, with instructor permission. Audited courses appear on your transcript but do not count toward degree requirements or GPA. You pay reduced fees and are not required to complete assignments or exams.'',
    keywords = [''audit'', ''course'', ''non-credit''],
    cat = Policies \<rparr>,
    
  \<lparr> question = ''What is the grade grievance procedure?'',
    answer = ''Students have the right to understand grading criteria and challenge grades they believe are unfair. Follow the appeals process outlined in the student handbook.'',
    keywords = [''grade'', ''grievance'', ''policy'', ''challenge''],
    cat = Policies \<rparr>
]"

(* Combine all FAQs into master knowledge base *)
definition knowledge_base :: "faq_entry list" where
"knowledge_base = 
  academic_faqs @ 
  registration_faqs @ 
  financial_faqs @ 
  graduation_faqs @ 
  administrative_faqs @ 
  appeals_faqs @
  schedule_faqs @
  policy_faqs"

(* ========================================
   QUERY MATCHING FUNCTIONS
   ======================================== *)

(* Synonym mapping for better matching *)
definition synonym_map :: "(string * string list) list" where
"synonym_map = [
  (''GPA'', [''grade'', ''grades'', ''average'', ''score'']),
  (''graduate'', [''finish'', ''complete'', ''graduation'', ''degree'']),
  (''major'', [''program'', ''course of study'', ''specialization'']),
  (''tuition'', [''fees'', ''payment'', ''cost'', ''money'']),
  (''register'', [''enroll'', ''registration'', ''sign up'', ''enrollment'']),
  (''transcript'', [''records'', ''grades'', ''academic record'']),
  (''appeal'', [''challenge'', ''dispute'', ''contest'']),
  (''withdraw'', [''drop'', ''leave'', ''quit'']),
  (''financial aid'', [''scholarship'', ''bursary'', ''grant'', ''funding'']),
  (''probation'', [''academic warning'', ''poor performance''])
]"

(* Check if a word or its synonyms appear in query *)
fun word_in_query :: "string \<Rightarrow> string \<Rightarrow> bool" where
"word_in_query word query = 
  (word \<in> set (words query))"

(* Check if keyword or any synonym matches *)
fun keyword_match_flexible :: "string \<Rightarrow> string \<Rightarrow> bool" where
"keyword_match_flexible keyword query = 
  (let query_lower = to_lowercase query;
       keyword_lower = to_lowercase keyword
   in word_in_query keyword_lower query_lower)"

(* Get synonyms for a keyword *)
fun get_synonyms :: "string \<Rightarrow> string list" where
"get_synonyms keyword = 
  (case List.find (\<lambda>(k, syns). k = keyword) synonym_map of
    Some (k, syns) \<Rightarrow> syns
  | None \<Rightarrow> [])"

(* Check if keyword or its synonyms appear in query *)
fun matches_with_synonyms :: "string \<Rightarrow> string \<Rightarrow> bool" where
"matches_with_synonyms keyword query =
  (keyword_match_flexible keyword query \<or>
   List.any (\<lambda>syn. keyword_match_flexible syn query) (get_synonyms keyword))"

(* Enhanced matching score with synonym support *)
fun match_score :: "string list \<Rightarrow> string \<Rightarrow> nat" where
"match_score [] query = 0" |
"match_score (k#ks) query = 
  (if matches_with_synonyms k query 
   then 2 + match_score ks query 
   else match_score ks query)"

(* Also check if question text itself partially matches *)
fun question_similarity :: "string \<Rightarrow> string \<Rightarrow> nat" where
"question_similarity faq_question user_query =
  (let faq_words = set (words (to_lowercase faq_question));
       query_words = set (words (to_lowercase user_query));
       common = faq_words \<inter> query_words
   in card common)"

(* Combined scoring: keyword match + question similarity *)
fun total_match_score :: "faq_entry \<Rightarrow> string \<Rightarrow> nat" where
"total_match_score faq query = 
  (let keyword_score = match_score (keywords faq) query;
       question_score = question_similarity (question faq) query
   in keyword_score * 3 + question_score)"

(* Convert string to lowercase for case-insensitive matching *)
fun to_lowercase :: "string \<Rightarrow> string" where
"to_lowercase s = s" (* Simplified - in practice would implement actual conversion *)

(* Find the best matching FAQ entry with improved scoring *)
fun find_best_match :: "faq_entry list \<Rightarrow> string \<Rightarrow> nat \<Rightarrow> faq_entry option \<Rightarrow> faq_entry option" where
"find_best_match [] query best_score best_entry = best_entry" |
"find_best_match (faq#faqs) query best_score best_entry = 
  (let score = total_match_score faq query in
   if score > best_score 
   then find_best_match faqs query score (Some faq)
   else find_best_match faqs query best_score best_entry)"

(* Main query function *)
definition query_kb :: "string \<Rightarrow> faq_entry option" where
"query_kb user_query = find_best_match knowledge_base user_query 0 None"

(* Extract answer from FAQ entry *)
fun get_answer :: "faq_entry option \<Rightarrow> string" where
"get_answer None = ''I apologize, but I could not find a matching answer in the knowledge base. Please rephrase your question or contact the Dean's office directly.''" |
"get_answer (Some faq) = answer faq"

(* ========================================
   QUERY INTERFACE
   ======================================== *)

definition process_query :: "string \<Rightarrow> string" where
"process_query user_query = get_answer (query_kb user_query)"

(* ========================================
   EXAMPLE QUERIES - Now more flexible!
   ======================================== *)

(* Exact matches *)
value "process_query ''What is the minimum GPA to graduate?''"
value "process_query ''How do I change my major?''"

(* Flexible queries - different wording *)
value "process_query ''minimum grade average needed for graduation''"
value "process_query ''switching my program''"
value "process_query ''when do I pay fees''"
value "process_query ''applying to finish my degree''"
value "process_query ''getting my academic records''"
value "process_query ''challenging a grade''"
value "process_query ''signing up for courses''"

(* Short informal queries *)
value "process_query ''GPA requirement''"
value "process_query ''change major''"
value "process_query ''tuition deadline''"
value "process_query ''get transcript''"

(* ========================================
   UTILITY FUNCTIONS
   ======================================== *)

(* Get all FAQs by category *)
fun filter_by_category :: "category \<Rightarrow> faq_entry list \<Rightarrow> faq_entry list" where
"filter_by_category c [] = []" |
"filter_by_category c (faq#faqs) = 
  (if cat faq = c 
   then faq # filter_by_category c faqs 
   else filter_by_category c faqs)"

(* Count total FAQs *)
definition total_faqs :: nat where
"total_faqs = length knowledge_base"

value "total_faqs"

(* Get all questions (for listing) *)
fun get_all_questions :: "faq_entry list \<Rightarrow> string list" where
"get_all_questions [] = []" |
"get_all_questions (faq#faqs) = question faq # get_all_questions faqs"

value "get_all_questions academic_faqs"

(* ========================================
   PROPERTIES AND VERIFICATION
   ======================================== *)

(* Property: Every FAQ has at least one keyword *)
lemma faq_has_keywords:
  "faq \<in> set knowledge_base \<Longrightarrow> keywords faq \<noteq> []"
  by (simp add: knowledge_base_def academic_faqs_def registration_faqs_def 
                financial_faqs_def graduation_faqs_def administrative_faqs_def
                appeals_faqs_def schedule_faqs_def policy_faqs_def)

(* Property: Knowledge base is non-empty *)
lemma kb_non_empty:
  "knowledge_base \<noteq> []"
  by (simp add: knowledge_base_def academic_faqs_def)

end